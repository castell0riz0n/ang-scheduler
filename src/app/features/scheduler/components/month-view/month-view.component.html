<div class="month-view-container">
  <!-- Week Header Row - Sticky -->
  <div class="month-header d-flex sticky-top bg-body shadow-sm">
    <!-- Time Gutter Header (Empty space above time labels) -->
    <div class="time-gutter-header bg-body-tertiary" role="columnheader" aria-label="Time">
      <span class="visually-hidden">Time</span>
    </div>

    @for (dayName of weekDayNames(); track $index) {
      <div class="month-header-cell text-center fw-semibold small text-muted text-uppercase flex-fill"
           [id]="'monthDayHeader-' + $index"
           [class.text-primary]="isDayToday($index)">
        {{ dayName }}
      </div>
    }
  </div>

  <!-- Scrollable Days Container -->
  <div class="month-body-scroll-container" #monthScrollContainer>
    <div class="d-flex h-100">
      <!-- Time Gutter (Hour Labels) -->
      <div class="time-gutter-body sticky-left bg-body-tertiary user-select-none" role="presentation">
        @for(hour of hourSegments(); track hour.displayLabel) {
          <div
            class="hour-label text-end pe-2 text-muted small d-flex align-items-center justify-content-end"
            [style.height.px]="hourSegmentHeight()"
            role="rowheader"
            [attr.aria-label]="hour.displayLabel"
          >
            {{ hour.displayLabel }}
          </div>
        }
      </div>

      <!-- Grid of Day Columns -->
      <div class="month-days-row d-flex flex-grow-1">
        @for (day of days(); track dayTrackBy($index, day)) {
          <div
            class="month-day-column flex-fill position-relative border-start"
            [class.bg-light]="!day.isCurrentMonth"
            [class.today-column]="day.isToday"
            [attr.data-date]="day.date.toISOString()"
            [id]="'day-' + day.date.toISOString()"
            role="gridcell"
            [attr.aria-labelledby]="'monthDayHeader-' + (day.date.getDay())"
          >
            <!-- Day Number Header -->
            <div class="day-number-header border-bottom p-1" [class.text-primary]="day.isToday" [class.fw-bold]="day.isToday">
              {{ day.date | date:'d' }}
            </div>

            <!-- Hour Slots -->
            <div class="hour-slots-container position-relative">
              @for(hour of hourSegments(); track hour.date.toISOString(); let hourIndex = $index) {
                <div
                  class="hour-slot border-bottom"
                  [style.height.px]="hourSegmentHeight()"
                  role="button"
                  [attr.aria-label]="'Time slot for ' + hour.displayLabel + ' on ' + (day.date | date:'EEEE')"
                  tabindex="0"
                  (click)="handleTimeSlotClick(day, hour)"
                  (keydown.enter)="handleTimeSlotClick(day, hour)"
                  (keydown.space)="$event.preventDefault(); handleTimeSlotClick(day, hour)"
                  cdkDropList
                  [cdkDropListData]="{ day: day, hourSegment: hour }"
                  (cdkDropListDropped)="onTimeSlotDrop($event, day, hour)"
                >
                </div>
              }
            </div>

            <!-- Events for this day, absolutely positioned OVER the hour slots -->
            <div class="events-overlay position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none;">
              @for(event of day.events; track event.id) {
                <div
                  cdkDrag
                  [cdkDragData]="event"
                  (cdkDragEnded)="onDragEnded($event)"
                  class="month-event-item-wrapper position-absolute"
                  [style]="getEventStyle(event)"
                  style="pointer-events: auto;"
                  role="button"
                  tabindex="0"
                  [attr.aria-label]="event.title + ' on ' + (day.date | date:'fullDate')"
                  (dblclick)="onEventClick(event, $event)"
                  (click)="onEventClick(event, $event)"
                  (keydown.enter)="onEventClick(event, $event)"
                  (keydown.space)="$event.preventDefault(); onEventClick(event, $event)"
                >
                  <app-event-item
                    [event]="event"
                    viewType="month"
                    [currentLocale]="locale()"
                    [currentTimeZone]="timeZone()"
                    (eventEdited)="onEventClick(event, $event)"
                  ></app-event-item>
                  <div *cdkDragPlaceholder class="drag-placeholder bg-info-subtle"></div>
                </div>
              }

              @if (getOverflowCount(day) > 0) {
                <div class="text-muted small mt-1 text-center overflow-indicator" style="pointer-events: auto;"
                     (click)="$event.stopPropagation(); onSlotClick(day)">
                  +{{ getOverflowCount(day) }} more
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>
